/**
 * @fileOverview
 * This ruleset enforces a strict user-ownership model for users, and public read access with owner-only writes for zones, interventions, and alerts.
 * Scenarios can only be created, updated, and deleted by the user who created them.
 *
 * Data Structure:
 * - /zones/{zoneId}: Stores zone data; publicly readable, owner-only writable.
 * - /interventions/{interventionId}: Stores intervention data; publicly readable, owner-only writable.
 * - /scenarios/{scenarioId}: Stores scenario data; owner-only access.
 * - /users/{userId}: Stores user profiles; only the user can read/write their own profile.
 * - /alerts/{alertId}: Stores alert data; publicly readable, owner-only writable.
 *
 * Key Security Decisions:
 * - Users can only manage their own profiles.
 * - Public read access is granted for zones, interventions and alerts to facilitate data discovery.
 * - Listing of any collection is only allowed by the user with the appropriate permissions, except for zones, interventions and alerts, which are open to the public for listing.
 *
 * Denormalization for Authorization:
 *  - Zones, Interventions and Alerts rely on an implicit ownership model.  The rule enforces writes only if `request.auth.uid` matches a given ownership field.
 *
 * Structural Segregation:
 *  - Drafts vs. published content is not applicable in this model, so all data is stored in a single collection per entity.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access and owner-only write access to zones.
     * @path /zones/{zoneId}
     * @allow (get, list): Any user can read zone data.
     * @allow (create): Only the authenticated user can create a zone, and the zone's ID must match their UID.
     * @allow (update, delete): Only the authenticated user who created the zone can modify or delete it.
     * @deny (create): An unauthenticated user cannot create a zone.
     * @deny (update, delete): A different authenticated user cannot modify or delete the zone.
     * @principle Public read, owner-only write access with ID consistency.
     */
    match /zones/{zoneId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }

    /**
     * @description Allows public read access and owner-only write access to interventions.
     * @path /interventions/{interventionId}
     * @allow (get, list): Any user can read intervention data.
     * @allow (create): Only the authenticated user can create an intervention, and the intervention's ID must match their UID.
     * @allow (update, delete): Only the authenticated user who created the intervention can modify or delete it.
     * @deny (create): An unauthenticated user cannot create an intervention.
     * @deny (update, delete): A different authenticated user cannot modify or delete the intervention.
     * @principle Public read, owner-only write access with ID consistency.
     */
    match /interventions/{interventionId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }

    /**
     * @description Allows owner-only access to scenarios.
     * @path /scenarios/{scenarioId}
     * @allow (get): Only the owner can read the scenario.
     * @allow (create): Only the authenticated user can create a scenario, and the scenario's createdBy field must match their UID.
     * @allow (update, delete): Only the owner can modify or delete the scenario, and the scenario must exist.
     * @deny (create): An unauthenticated user cannot create a scenario.
     * @deny (update, delete): A different authenticated user cannot modify or delete the scenario.
     * @principle Enforces document ownership for all operations.
     */
    match /scenarios/{scenarioId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }

    /**
     * @description Allows a user to only read and write their own profile data.
     * @path /users/{userId}
     * @allow (get): Only the user can read their own profile.
     * @allow (create): Only the user can create their own profile, and the userId must match their UID.
     * @allow (update, delete): Only the user can modify or delete their own profile, and the profile must exist.
     * @deny (create): An unauthenticated user cannot create a user profile.
     * @deny (update, delete): A different authenticated user cannot modify or delete the user's profile.
     * @principle Strict user-ownership model.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update, delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access and owner-only write access to alerts.
     * @path /alerts/{alertId}
     * @allow (get, list): Any user can read alert data.
     * @allow (create): Only the authenticated user can create an alert, and the alert's ID must match their UID.
     * @allow (update, delete): Only the authenticated user who created the alert can modify or delete it.
     * @deny (create): An unauthenticated user cannot create an alert.
     * @deny (update, delete): A different authenticated user cannot modify or delete the alert.
     * @principle Public read, owner-only write access with ID consistency.
     */
    match /alerts/{alertId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     * @example isSignedIn() == true if request.auth != null
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the document based on the provided userId.
     * @param {string} userId - The user ID to compare against the authenticated user's UID.
     * @returns {boolean} True if the authenticated user's UID matches the provided userId, false otherwise.
     * @example isOwner('user123') == true if request.auth.uid == 'user123'
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
  }
}